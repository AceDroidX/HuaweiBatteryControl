<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.62">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>华为笔记本充电控制逆向过程记录 | HuaweiBatteryControl</title><meta name="description" content="华为笔记本充电控制逆向过程记录">
    <link rel="preload" href="/HuaweiBatteryControl/assets/style-7c7ea8e4.css" as="style"><link rel="stylesheet" href="/HuaweiBatteryControl/assets/style-7c7ea8e4.css">
    <link rel="modulepreload" href="/HuaweiBatteryControl/assets/app-659d6a32.js"><link rel="modulepreload" href="/HuaweiBatteryControl/assets/index.html-fcfb80b3.js"><link rel="modulepreload" href="/HuaweiBatteryControl/assets/index.html-f6431f95.js"><link rel="prefetch" href="/HuaweiBatteryControl/assets/404.html-f9875e7b.js" as="script"><link rel="prefetch" href="/HuaweiBatteryControl/assets/404.html-f9e8b379.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a aria-current="page" href="/HuaweiBatteryControl/" class="router-link-active router-link-exact-active"><!----><span class="site-name">HuaweiBatteryControl</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><!----><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><!----><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">华为笔记本充电控制逆向过程记录 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/HuaweiBatteryControl/#引言" class="router-link-active router-link-exact-active sidebar-item" aria-label="引言"><!--[--><!--]--> 引言 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/HuaweiBatteryControl/#开始" class="router-link-active router-link-exact-active sidebar-item" aria-label="开始"><!--[--><!--]--> 开始 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/HuaweiBatteryControl/#再次梳理" class="router-link-active router-link-exact-active sidebar-item" aria-label="再次梳理"><!--[--><!--]--> 再次梳理 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/HuaweiBatteryControl/#获取参数" class="router-link-active router-link-exact-active sidebar-item" aria-label="获取参数"><!--[--><!--]--> 获取参数 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/HuaweiBatteryControl/#尝试调用" class="router-link-active router-link-exact-active sidebar-item" aria-label="尝试调用"><!--[--><!--]--> 尝试调用 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/HuaweiBatteryControl/#深入逆向" class="router-link-active router-link-exact-active sidebar-item" aria-label="深入逆向"><!--[--><!--]--> 深入逆向 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/HuaweiBatteryControl/#最终成果" class="router-link-active router-link-exact-active sidebar-item" aria-label="最终成果"><!--[--><!--]--> 最终成果 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="华为笔记本充电控制逆向过程记录" tabindex="-1"><a class="header-anchor" href="#华为笔记本充电控制逆向过程记录" aria-hidden="true">#</a> 华为笔记本充电控制逆向过程记录</h1><h2 id="引言" tabindex="-1"><a class="header-anchor" href="#引言" aria-hidden="true">#</a> 引言</h2><p>华为的笔记本出厂会带个电脑管家，里面除了驱动更新和背光热键设置之外，还有华为自己的多屏协同、设备互联功能，然而这些功能我都用不到。后台常驻四五个进程，还时不时的弹窗的体验可说不上好。</p><p>之后又买了台Matebook E GO，在这台设备上的电脑管家除了「花里胡哨」的功能更多之外，更是有从S0睡眠恢复后，CPU异常高占用的问题。精简后台迫在眉睫，我唯一需要的后台常驻功能是其中的「智能充电」，也就是笔记本标配的充电控制，因此就有了这个项目的想法 <img src="/HuaweiBatteryControl/assets/1.1-30aa15a2.png" alt="1.1"></p><h2 id="开始" tabindex="-1"><a class="header-anchor" href="#开始" aria-hidden="true">#</a> 开始</h2><p>首先搜索相关资料，目前网上的华为充电控制都是Linux的项目，并且所有项目都依赖这个内核驱动：<a href="https://github.com/aymanbagabas/Huawei-WMI" target="_blank" rel="noopener noreferrer">Huawei-WMI<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>看过后大概能知道是通过WMI(Windows Management Instrumentation)控制的，不过WMI怎么用？WMI GUID哪里找？结构体参数类型是什么？这些对于我这个没接触过原生Windows开发的还是有点难</p><p>好吧既然看不懂那就直接上手，x64dbg启动！附加到主进程<code>PCManager.exe</code>直接搜索字符串<code>wmi</code>看看有什么： <img src="/HuaweiBatteryControl/assets/2.1-6c3c2224.png" alt="2.1"> 找到几个有意思的字符串：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>L<span class="token string">&quot;ROOT\\WMI&quot;</span>
L<span class="token string">&quot;ACPI\\PNP0C14\\HWMI_0&quot;</span>
L<span class="token string">&quot;OemWMIMethod&quot;</span>
L<span class="token string">&quot;OemWMIfun&quot;</span>
L<span class="token string">&quot;OemWMIEvent&quot;</span>
<span class="token operator">&amp;</span>L<span class="token string">&quot;SELECT * FROM OemWMIEvent &quot;</span>
<span class="token string">&quot;BiosWmi::GetOutPutUIntEx&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ok我们给这些地址全打上断点，再切换电池控制模式： <img src="/HuaweiBatteryControl/assets/2.2-ba28fdd2.png" alt="2.2"> 嗯？怎么没断上呢？看到下面的ipc message才反应过来，原来这有好几个进程，<code>PCManager.exe</code>只是作为UI通知后台服务的。再给剩下的两个进程<code>MBAMessageCenter.exe</code>和<code>PCManagerMainService.exe</code>同样搜索字符串并全打上断点：</p><p>看来只有<code>MBAMessageCenter.exe</code>的几个断点能成功生效，<code>HardwareHal.dll</code>就是其中的关键： <img src="/HuaweiBatteryControl/assets/2.3-373879cd.png" alt="2.3"></p><p>然后根据栈和上下文得知会调用<code>HalWmi::GetOutPutUIntEx</code>这个函数： <img src="/HuaweiBatteryControl/assets/2.4-783a4e97.png" alt="2.4"></p><h2 id="再次梳理" tabindex="-1"><a class="header-anchor" href="#再次梳理" aria-hidden="true">#</a> 再次梳理</h2><p>由上文得知程序会通过路径<code>ROOT\\WMI</code>，调用<code>OemWMIMethod</code>和<code>OemWMIfun</code>这两个WMI函数</p><p>我们试试用<a href="https://github.com/vinaypamnani/wmie2" target="_blank" rel="noopener noreferrer">WmiExplorer<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>查看这函数有哪些参数： <img src="/HuaweiBatteryControl/assets/3.1-1e55c39c.png" alt="3.1"></p><p>这下就非常清楚是怎么调用的了： 首先转到路径<code>ROOT\\WMI</code>，找到类<code>OemWMIMethod</code>，获取实例后，调用函数<code>OemWMIfun</code>，参数类型为<code>uint8 []</code></p><p>这里给出MOF(Managed Object Format)：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token punctuation">[</span>dynamic<span class="token operator">:</span> <span class="token class-name">ToInstance</span><span class="token punctuation">,</span> <span class="token function">provider</span><span class="token punctuation">(</span><span class="token string">&quot;WMIProv&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">WMI</span><span class="token punctuation">,</span> <span class="token class-name">Description</span><span class="token punctuation">(</span><span class="token string">&quot;Call BIOS Function through WMI&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">GUID</span><span class="token punctuation">(</span><span class="token string">&quot;{ABBC0f5b-8ea1-11d1-A000-c90629100000}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">locale</span><span class="token punctuation">(</span><span class="token string">&quot;MS\\0x409&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">class</span> <span class="token class-name">OemWMIMethod</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span>key<span class="token punctuation">,</span> read<span class="token punctuation">]</span> string <span class="token class-name">InstanceName</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>read<span class="token punctuation">]</span> <span class="token class-name">Boolean</span> <span class="token class-name">Active</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token class-name">WmiMethodId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Implemented</span><span class="token punctuation">,</span> read<span class="token punctuation">,</span> write<span class="token punctuation">,</span> <span class="token class-name">Description</span><span class="token punctuation">(</span><span class="token string">&quot;OEM WMI Function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">void</span> <span class="token class-name">OemWMIfun</span><span class="token punctuation">(</span><span class="token punctuation">[</span>in<span class="token punctuation">,</span> <span class="token function">MAX</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">]</span> uint8 u8Input<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>out<span class="token punctuation">]</span> uint32 u32Resrved<span class="token punctuation">,</span> <span class="token punctuation">[</span>out<span class="token punctuation">,</span> <span class="token function">MAX</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">]</span> uint8 u8Output<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="获取参数" tabindex="-1"><a class="header-anchor" href="#获取参数" aria-hidden="true">#</a> 获取参数</h2><p>现在我们得知大概的调用过程，但是参数具体该填什么还不清楚，再回到x64dbg看下： <img src="/HuaweiBatteryControl/assets/4.1-8b1f6674.png" alt="4.1"> 这里可以看到<code>IWbemClassObject::Put</code>和一个可疑的字符串<code>L&quot;1177030659&quot;</code></p><p>选择不同充电选项后都会有对应的字符串，经过测试后得出：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">1677725699</span> 关闭
<span class="token number">1514541059</span> <span class="token number">90</span>%
<span class="token number">1177030659</span> <span class="token number">70</span>%
<span class="token number">1683951619</span> <span class="token number">100</span>%
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>一眼看出这种数值是16进制的，转换之后：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">64001003</span> 关闭
5A461003 <span class="token number">90</span>%
<span class="token number">46281003</span> <span class="token number">70</span>%
645F1003 <span class="token number">100</span>%
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>后四位都是1003，0x6400感觉像是十进制的100和0，试试看每两位转成十进制：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">100,0</span>,16,3 关闭
<span class="token number">90,70</span>,16,3 <span class="token number">90</span>%
<span class="token number">70,40</span>,16,3 <span class="token number">70</span>%
<span class="token number">100,95</span>,16,3 <span class="token number">100</span>%
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这下完全明白是什么意思了，十六进制前两位是上限，再两位是下限，后面1003固定值</p><h2 id="尝试调用" tabindex="-1"><a class="header-anchor" href="#尝试调用" aria-hidden="true">#</a> 尝试调用</h2><p>接下来试试用PowerShell调用WMI函数，然而怎么输入都报无效参数的错误</p><details><summary>PowerShell</summary><p><div class="language-powershell line-numbers-mode" data-ext="powershell"><pre class="language-powershell"><code><span class="token function">PS</span> D:\&gt; <span class="token function">Get-WmiObject</span> <span class="token operator">-</span>Namespace <span class="token string">&quot;root/wmi&quot;</span> OemWMIMethod <span class="token operator">-</span>List

   NameSpace:ROOT\WMI

Name                                Methods              Properties
<span class="token operator">--</span><span class="token operator">--</span>                                <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>              <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
OemWMIMethod                        <span class="token punctuation">{</span>OemWMIfun<span class="token punctuation">}</span>          <span class="token punctuation">{</span>Active<span class="token punctuation">,</span> InstanceName<span class="token punctuation">}</span>

<span class="token function">PS</span> D:\&gt; <span class="token punctuation">(</span><span class="token function">Get-WmiObject</span> <span class="token operator">-</span>Namespace <span class="token string">&quot;root/wmi&quot;</span> <span class="token operator">-</span><span class="token keyword">Class</span> OemWMIMethod<span class="token punctuation">)</span><span class="token punctuation">.</span>OemWMIfun<span class="token punctuation">(</span>1514541059<span class="token punctuation">)</span>
无法将“OemWMIfun”的参数“0”<span class="token punctuation">(</span>其值为“1514541059”<span class="token punctuation">)</span>转换为类型“System<span class="token punctuation">.</span>Byte<span class="token punctuation">[</span><span class="token punctuation">]</span>”:“无法将值“1514541059”转换为类型“Sys
tem<span class="token punctuation">.</span>Byte<span class="token punctuation">[</span><span class="token punctuation">]</span>”。错误:“无法将值“1514541059”转换为类型“System<span class="token punctuation">.</span>Byte”。错误:“值对于无符号的字节太大或太小。”””

<span class="token function">PS</span> D:\&gt; <span class="token punctuation">(</span><span class="token function">Get-WmiObject</span> <span class="token operator">-</span>Namespace <span class="token string">&quot;root/wmi&quot;</span> <span class="token operator">-</span><span class="token keyword">Class</span> OemWMIMethod<span class="token punctuation">)</span><span class="token punctuation">.</span>OemWMIfun<span class="token punctuation">(</span>8<span class="token punctuation">,</span>8<span class="token punctuation">)</span>
找不到“OemWMIfun”的重载，参数计数为:“2”。

<span class="token function">PS</span> D:\&gt; <span class="token punctuation">(</span><span class="token function">Get-WmiObject</span> <span class="token operator">-</span>Namespace <span class="token string">&quot;root/wmi&quot;</span> <span class="token operator">-</span><span class="token keyword">Class</span> OemWMIMethod<span class="token punctuation">)</span><span class="token punctuation">.</span>OemWMIfun<span class="token punctuation">(</span><span class="token namespace">[Byte[]]</span>::new<span class="token punctuation">(</span>1<span class="token punctuation">)</span><span class="token punctuation">)</span>
调用“OemWMIfun”时发生异常:“无效的参数 ”

<span class="token function">PS</span> D:\&gt; <span class="token punctuation">(</span><span class="token function">Get-WmiObject</span> <span class="token operator">-</span>Namespace <span class="token string">&quot;root/wmi&quot;</span> <span class="token operator">-</span><span class="token keyword">Class</span> OemWMIMethod<span class="token punctuation">)</span><span class="token punctuation">.</span>OemWMIfun<span class="token punctuation">(</span>0x02<span class="token punctuation">)</span>
调用“OemWMIfun”时发生异常:“无效的参数 ”

<span class="token function">PS</span> D:\&gt; <span class="token punctuation">(</span><span class="token function">Get-WmiObject</span> <span class="token operator">-</span>Namespace <span class="token string">&quot;root/wmi&quot;</span> <span class="token operator">-</span><span class="token keyword">Class</span> OemWMIMethod<span class="token punctuation">)</span><span class="token punctuation">.</span>OemWMIfun<span class="token punctuation">(</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">)</span>
调用“OemWMIfun”时发生异常:“无效的参数 ”

<span class="token function">PS</span> D:\&gt; <span class="token namespace">[byte[]]</span> <span class="token variable">$b</span> = 90<span class="token punctuation">,</span>70<span class="token punctuation">,</span>16<span class="token punctuation">,</span>3
<span class="token function">PS</span> D:\&gt; <span class="token punctuation">(</span><span class="token function">Get-WmiObject</span> <span class="token operator">-</span>Namespace <span class="token string">&quot;root/wmi&quot;</span> <span class="token operator">-</span><span class="token keyword">Class</span> OemWMIMethod<span class="token punctuation">)</span><span class="token punctuation">.</span>OemWMIfun<span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span>
调用“OemWMIfun”时发生异常:“无效的参数 ”
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></p></details><p>再试试用C#呢，好吧还是一样报错</p><details><summary>C#</summary><p><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Management</span><span class="token punctuation">;</span>

<span class="token class-name">ManagementObjectSearcher</span> searcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ManagementObjectSearcher</span><span class="token punctuation">(</span><span class="token string">&quot;ROOT\\WMI&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Select * From OemWMIMethod&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> moCollects <span class="token operator">=</span> searcher<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">ManagementObject</span> mo <span class="token keyword">in</span> moCollects<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">ManagementBaseObject</span> inParams <span class="token operator">=</span> mo<span class="token punctuation">.</span><span class="token function">GetMethodParameters</span><span class="token punctuation">(</span><span class="token string">&quot;OemWMIfun&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> data <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    inParams<span class="token punctuation">[</span><span class="token string">&quot;u8Input&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>
    <span class="token class-name">ManagementBaseObject</span> outMPParams <span class="token operator">=</span> mo<span class="token punctuation">.</span><span class="token function">InvokeMethod</span><span class="token punctuation">(</span><span class="token string">&quot;OemWMIfun&quot;</span><span class="token punctuation">,</span> inParams<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>Unhandled exception. System.Management.ManagementException: 无效的参数
   at System.Management.ManagementException.ThrowWithExtendedInfo<span class="token punctuation">(</span>ManagementStatus errorCode<span class="token punctuation">)</span>
   at System.Management.ManagementObject.InvokeMethod<span class="token punctuation">(</span>String methodName, ManagementBaseObject inParameters, InvokeMethodOptions options<span class="token punctuation">)</span>
   at Program.<span class="token operator">&lt;</span>Main<span class="token operator">&gt;</span><span class="token variable"><span class="token variable">$(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token variable">)</span></span> <span class="token keyword">in</span> D:<span class="token punctuation">\</span>Github<span class="token punctuation">\</span>HuaweiBatteryControlCS<span class="token punctuation">\</span>HuaweiBatteryControlCS<span class="token punctuation">\</span>Program.cs:line <span class="token number">10</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></p></details><h2 id="深入逆向" tabindex="-1"><a class="header-anchor" href="#深入逆向" aria-hidden="true">#</a> 深入逆向</h2><p>PowerShell和C#都不行，看来得按照程序的逻辑用C写一遍了</p><p>搜索C++如何调用WMI方法，微软给了个比较完整的示例： <a href="https://learn.microsoft.com/en-us/windows/win32/wmisdk/example--calling-a-provider-method" target="_blank" rel="noopener noreferrer">https://learn.microsoft.com/en-us/windows/win32/wmisdk/example--calling-a-provider-method<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><details><summary>C++</summary><p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_WIN32_DCOM</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;comdef.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Wbemidl.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">comment</span><span class="token punctuation">(</span>lib<span class="token punctuation">,</span> </span><span class="token string">&quot;wbemuuid.lib&quot;</span><span class="token expression"><span class="token punctuation">)</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> iArgCnt<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    HRESULT hres<span class="token punctuation">;</span>

    <span class="token comment">// Step 1: --------------------------------------------------</span>
    <span class="token comment">// Initialize COM. ------------------------------------------</span>

    hres <span class="token operator">=</span>  <span class="token function">CoInitializeEx</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> COINIT_MULTITHREADED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hres<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Failed to initialize COM library. Error code = 0x&quot;</span> 
             <span class="token operator">&lt;&lt;</span> hex <span class="token operator">&lt;&lt;</span> hres <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>                  <span class="token comment">// Program has failed.</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Step 2: --------------------------------------------------</span>
    <span class="token comment">// Set general COM security levels --------------------------</span>

    hres <span class="token operator">=</span>  <span class="token function">CoInitializeSecurity</span><span class="token punctuation">(</span>
        <span class="token constant">NULL</span><span class="token punctuation">,</span> 
        <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>                          <span class="token comment">// COM negotiates service</span>
        <span class="token constant">NULL</span><span class="token punctuation">,</span>                        <span class="token comment">// Authentication services</span>
        <span class="token constant">NULL</span><span class="token punctuation">,</span>                        <span class="token comment">// Reserved</span>
        RPC_C_AUTHN_LEVEL_DEFAULT<span class="token punctuation">,</span>   <span class="token comment">// Default authentication </span>
        RPC_C_IMP_LEVEL_IMPERSONATE<span class="token punctuation">,</span> <span class="token comment">// Default Impersonation</span>
        <span class="token constant">NULL</span><span class="token punctuation">,</span>                        <span class="token comment">// Authentication info</span>
        EOAC_NONE<span class="token punctuation">,</span>                   <span class="token comment">// Additional capabilities </span>
        <span class="token constant">NULL</span>                         <span class="token comment">// Reserved</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hres<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Failed to initialize security. Error code = 0x&quot;</span> 
             <span class="token operator">&lt;&lt;</span> hex <span class="token operator">&lt;&lt;</span> hres <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token function">CoUninitialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>                      <span class="token comment">// Program has failed.</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Step 3: ---------------------------------------------------</span>
    <span class="token comment">// Obtain the initial locator to WMI -------------------------</span>

    IWbemLocator <span class="token operator">*</span>pLoc <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    hres <span class="token operator">=</span> <span class="token function">CoCreateInstance</span><span class="token punctuation">(</span>
        CLSID_WbemLocator<span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> 
        CLSCTX_INPROC_SERVER<span class="token punctuation">,</span> 
        IID_IWbemLocator<span class="token punctuation">,</span> <span class="token punctuation">(</span>LPVOID <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>pLoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hres<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Failed to create IWbemLocator object. &quot;</span>
             <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Err code = 0x&quot;</span>
             <span class="token operator">&lt;&lt;</span> hex <span class="token operator">&lt;&lt;</span> hres <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token function">CoUninitialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>                 <span class="token comment">// Program has failed.</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Step 4: ---------------------------------------------------</span>
    <span class="token comment">// Connect to WMI through the IWbemLocator::ConnectServer method</span>

    IWbemServices <span class="token operator">*</span>pSvc <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
 
    <span class="token comment">// Connect to the local root\cimv2 namespace</span>
    <span class="token comment">// and obtain pointer pSvc to make IWbemServices calls.</span>
    hres <span class="token operator">=</span> pLoc<span class="token operator">-&gt;</span><span class="token function">ConnectServer</span><span class="token punctuation">(</span>
        <span class="token function">_bstr_t</span><span class="token punctuation">(</span>L<span class="token string">&quot;ROOT\\CIMV2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        <span class="token constant">NULL</span><span class="token punctuation">,</span>
        <span class="token constant">NULL</span><span class="token punctuation">,</span> 
        <span class="token number">0</span><span class="token punctuation">,</span> 
        <span class="token constant">NULL</span><span class="token punctuation">,</span> 
        <span class="token number">0</span><span class="token punctuation">,</span> 
        <span class="token number">0</span><span class="token punctuation">,</span> 
        <span class="token operator">&amp;</span>pSvc
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hres<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Could not connect. Error code = 0x&quot;</span> 
             <span class="token operator">&lt;&lt;</span> hex <span class="token operator">&lt;&lt;</span> hres <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        pLoc<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CoUninitialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>                <span class="token comment">// Program has failed.</span>
    <span class="token punctuation">}</span>

    cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Connected to ROOT\\CIMV2 WMI namespace&quot;</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>


    <span class="token comment">// Step 5: --------------------------------------------------</span>
    <span class="token comment">// Set security levels for the proxy ------------------------</span>

    hres <span class="token operator">=</span> <span class="token function">CoSetProxyBlanket</span><span class="token punctuation">(</span>
        pSvc<span class="token punctuation">,</span>                        <span class="token comment">// Indicates the proxy to set</span>
        RPC_C_AUTHN_WINNT<span class="token punctuation">,</span>           <span class="token comment">// RPC_C_AUTHN_xxx </span>
        RPC_C_AUTHZ_NONE<span class="token punctuation">,</span>            <span class="token comment">// RPC_C_AUTHZ_xxx </span>
        <span class="token constant">NULL</span><span class="token punctuation">,</span>                        <span class="token comment">// Server principal name </span>
        RPC_C_AUTHN_LEVEL_CALL<span class="token punctuation">,</span>      <span class="token comment">// RPC_C_AUTHN_LEVEL_xxx </span>
        RPC_C_IMP_LEVEL_IMPERSONATE<span class="token punctuation">,</span> <span class="token comment">// RPC_C_IMP_LEVEL_xxx</span>
        <span class="token constant">NULL</span><span class="token punctuation">,</span>                        <span class="token comment">// client identity</span>
        EOAC_NONE                    <span class="token comment">// proxy capabilities </span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hres<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Could not set proxy blanket. Error code = 0x&quot;</span> 
             <span class="token operator">&lt;&lt;</span> hex <span class="token operator">&lt;&lt;</span> hres <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        pSvc<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pLoc<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CoUninitialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>               <span class="token comment">// Program has failed.</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Step 6: --------------------------------------------------</span>
    <span class="token comment">// Use the IWbemServices pointer to make requests of WMI ----</span>

    <span class="token comment">// set up to call the Win32_Process::Create method</span>
    BSTR MethodName <span class="token operator">=</span> <span class="token function">SysAllocString</span><span class="token punctuation">(</span>L<span class="token string">&quot;Create&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    BSTR ClassName <span class="token operator">=</span> <span class="token function">SysAllocString</span><span class="token punctuation">(</span>L<span class="token string">&quot;Win32_Process&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    IWbemClassObject<span class="token operator">*</span> pClass <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    hres <span class="token operator">=</span> pSvc<span class="token operator">-&gt;</span><span class="token function">GetObject</span><span class="token punctuation">(</span>ClassName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pClass<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    IWbemClassObject<span class="token operator">*</span> pInParamsDefinition <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    hres <span class="token operator">=</span> pClass<span class="token operator">-&gt;</span><span class="token function">GetMethod</span><span class="token punctuation">(</span>MethodName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 
        <span class="token operator">&amp;</span>pInParamsDefinition<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    IWbemClassObject<span class="token operator">*</span> pClassInstance <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    hres <span class="token operator">=</span> pInParamsDefinition<span class="token operator">-&gt;</span><span class="token function">SpawnInstance</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pClassInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the values for the in parameters</span>
    VARIANT varCommand<span class="token punctuation">;</span>
    varCommand<span class="token punctuation">.</span>vt <span class="token operator">=</span> VT_BSTR<span class="token punctuation">;</span>
    varCommand<span class="token punctuation">.</span>bstrVal <span class="token operator">=</span> <span class="token function">_bstr_t</span><span class="token punctuation">(</span>L<span class="token string">&quot;notepad.exe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Store the value for the in parameters</span>
    hres <span class="token operator">=</span> pClassInstance<span class="token operator">-&gt;</span><span class="token function">Put</span><span class="token punctuation">(</span>L<span class="token string">&quot;CommandLine&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>varCommand<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">wprintf</span><span class="token punctuation">(</span>L<span class="token string">&quot;The command is: %s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">V_BSTR</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>varCommand<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Execute Method</span>
    IWbemClassObject<span class="token operator">*</span> pOutParams <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    hres <span class="token operator">=</span> pSvc<span class="token operator">-&gt;</span><span class="token function">ExecMethod</span><span class="token punctuation">(</span>ClassName<span class="token punctuation">,</span> MethodName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span> pClassInstance<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pOutParams<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hres<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Could not execute method. Error code = 0x&quot;</span> 
             <span class="token operator">&lt;&lt;</span> hex <span class="token operator">&lt;&lt;</span> hres <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token function">VariantClear</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>varCommand<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SysFreeString</span><span class="token punctuation">(</span>ClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SysFreeString</span><span class="token punctuation">(</span>MethodName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pClass<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pClassInstance<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pInParamsDefinition<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pOutParams<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pSvc<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pLoc<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CoUninitialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>               <span class="token comment">// Program has failed.</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// To see what the method returned,</span>
    <span class="token comment">// use the following code.  The return value will</span>
    <span class="token comment">// be in &amp;varReturnValue</span>
    VARIANT varReturnValue<span class="token punctuation">;</span>
    hres <span class="token operator">=</span> pOutParams<span class="token operator">-&gt;</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token function">_bstr_t</span><span class="token punctuation">(</span>L<span class="token string">&quot;ReturnValue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 
        <span class="token operator">&amp;</span>varReturnValue<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// Clean up</span>
    <span class="token comment">//--------------------------</span>
    <span class="token function">VariantClear</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>varCommand<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">VariantClear</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>varReturnValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SysFreeString</span><span class="token punctuation">(</span>ClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SysFreeString</span><span class="token punctuation">(</span>MethodName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pClass<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pClassInstance<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pInParamsDefinition<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pOutParams<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pLoc<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pSvc<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CoUninitialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></p></details><p>同样的，我们的目标是第六步传参环节。打开IDA分析前面看到的<code>HalWmi::GetOutPutUIntEx</code>函数，反编译成伪代码配合x64dbg加上注释，这里推荐这篇文章<a href="https://tttang.com/archive/1640" target="_blank" rel="noopener noreferrer">WMI调试与检测<a href="https://tttang.com/archive/1640" target="_blank" rel="noopener noreferrer">https://tttang.com/archive/1640<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></a>，可以看到代码逻辑和示例差不多： <img src="/HuaweiBatteryControl/assets/6.1-527ce85f.png" alt="6.1"><img src="/HuaweiBatteryControl/assets/6.2-b006a227.png" alt="6.2"></p><p>再仔细看下<code>sub_7FF9FF7AFDB0</code>这个函数，没错这就是传参的关键：</p><details><summary>C++伪代码</summary><p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">bool</span> __fastcall <span class="token function">sub_7FF9FF7AFDB0</span><span class="token punctuation">(</span>__int64 <span class="token operator">*</span>a1<span class="token punctuation">,</span> __int64 a2<span class="token punctuation">,</span> __int64 a3<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">bool</span> v5<span class="token punctuation">;</span> <span class="token comment">// zf</span>
  <span class="token keyword">bool</span> v6<span class="token punctuation">;</span> <span class="token comment">// si</span>
  SAFEARRAY <span class="token operator">*</span>v7<span class="token punctuation">;</span> <span class="token comment">// rdi</span>
  <span class="token keyword">unsigned</span> __int64 v8<span class="token punctuation">;</span> <span class="token comment">// r8</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>v9<span class="token punctuation">;</span> <span class="token comment">// r9</span>
  <span class="token keyword">unsigned</span> __int64 v10<span class="token punctuation">;</span> <span class="token comment">// rdx</span>
  __int64 v11<span class="token punctuation">;</span> <span class="token comment">// rbx</span>
  <span class="token keyword">const</span> OLECHAR <span class="token operator">*</span>v12<span class="token punctuation">;</span> <span class="token comment">// rcx</span>
  BSTR v13<span class="token punctuation">;</span> <span class="token comment">// rbx</span>
  OLECHAR <span class="token operator">*</span>v14<span class="token punctuation">;</span> <span class="token comment">// rcx</span>
  __int64 v15<span class="token punctuation">;</span> <span class="token comment">// rcx</span>
  SAFEARRAY <span class="token operator">*</span>v16<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  __int64 v17<span class="token punctuation">;</span> <span class="token comment">// rcx</span>
  OLECHAR <span class="token operator">*</span>psz<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+38h] [rbp-59h] BYREF</span>
  __m128i si128<span class="token punctuation">;</span> <span class="token comment">// [rsp+48h] [rbp-49h]</span>
  VARIANTARG pvarg<span class="token punctuation">;</span> <span class="token comment">// [rsp+58h] [rbp-39h] BYREF</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>ppvData<span class="token punctuation">;</span> <span class="token comment">// [rsp+70h] [rbp-21h] BYREF</span>
  __int64 v23<span class="token punctuation">;</span> <span class="token comment">// [rsp+78h] [rbp-19h]</span>
  SAFEARRAYBOUND rgsabound<span class="token punctuation">;</span> <span class="token comment">// [rsp+80h] [rbp-11h] BYREF</span>
  <span class="token keyword">char</span> v25<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+B2h] [rbp+21h] BYREF</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>a1 <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  v5 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a3 <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>i64<span class="token punctuation">;</span>
  v23 <span class="token operator">=</span> <span class="token operator">*</span>a1<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  v6 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  v7 <span class="token operator">=</span> <span class="token number">0</span>i64<span class="token punctuation">;</span>
  <span class="token function">VariantInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pvarg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v8 <span class="token operator">=</span> v23<span class="token punctuation">;</span>
  v9 <span class="token operator">=</span> v25<span class="token punctuation">;</span>
  pvarg<span class="token punctuation">.</span>vt <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
  <span class="token keyword">do</span>
  <span class="token punctuation">{</span>
    v9 <span class="token operator">-=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v9 <span class="token operator">=</span> v8 <span class="token operator">%</span> <span class="token number">0xA</span> <span class="token operator">+</span> <span class="token number">48</span><span class="token punctuation">;</span>
    v8 <span class="token operator">/=</span> <span class="token number">0xAu</span>i64<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> v8 <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LOWORD</span><span class="token punctuation">(</span>psz<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  si128 <span class="token operator">=</span> <span class="token function">_mm_load_si128</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> __m128i <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>xmmword_7FF9FF7BA560<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v9 <span class="token operator">!=</span> v25 <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    v10 <span class="token operator">=</span> <span class="token punctuation">(</span>v25 <span class="token operator">-</span> v9<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v10 <span class="token operator">&gt;</span> <span class="token number">7</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token function">sub_7FF9FF792FA0</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>psz<span class="token punctuation">,</span> v10<span class="token punctuation">,</span> <span class="token number">0</span>i64<span class="token punctuation">,</span> v9<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
      v11 <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> v10<span class="token punctuation">;</span>
      si128<span class="token punctuation">.</span>m128i_i64<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>v25 <span class="token operator">-</span> v9<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token function">memmove</span><span class="token punctuation">(</span>psz<span class="token punctuation">,</span> v9<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> v10<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>psz <span class="token operator">+</span> v11<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  v12 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> OLECHAR <span class="token operator">*</span><span class="token punctuation">)</span>psz<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> si128<span class="token punctuation">.</span>m128i_i64<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;=</span> <span class="token number">8u</span>i64 <span class="token punctuation">)</span>
    v12 <span class="token operator">=</span> psz<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  v13 <span class="token operator">=</span> <span class="token function">SysAllocString</span><span class="token punctuation">(</span>v12<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> si128<span class="token punctuation">.</span>m128i_i64<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;=</span> <span class="token number">8u</span>i64 <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    v14 <span class="token operator">=</span> psz<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int64<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> si128<span class="token punctuation">.</span>m128i_i64<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0x1000</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      v14 <span class="token operator">=</span> <span class="token punctuation">(</span>OLECHAR <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>psz<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int64<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>psz<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>v14 <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0x1F</span> <span class="token punctuation">)</span>
        <span class="token function">invalid_parameter_noinfo_noreturn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">j_j_free</span><span class="token punctuation">(</span>v14<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  v15 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a3 <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pvarg<span class="token punctuation">.</span>llVal <span class="token operator">=</span> <span class="token punctuation">(</span>LONGLONG<span class="token punctuation">)</span>v13<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token punctuation">(</span>__fastcall <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>__int64<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">wchar_t</span> <span class="token operator">*</span><span class="token punctuation">,</span> _QWORD<span class="token punctuation">,</span> VARIANTARG <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>v15
                                                                                           <span class="token operator">+</span> <span class="token number">40</span>i64<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token comment">// &lt;fastprox.&amp;public: virtual long __cdecl CWbemInstance::Put(unsigned short const *, long, struct tagVARIANT *, long)&gt;]=&lt;fastprox.public: virtual long __cdecl CWbemInstance::Put(unsigned short const *, long, struct tagVARIANT *, long)&gt;</span>
         v15<span class="token punctuation">,</span>
         L<span class="token string">&quot;u64Input&quot;</span><span class="token punctuation">,</span>
         <span class="token number">0</span>i64<span class="token punctuation">,</span>
         <span class="token operator">&amp;</span>pvarg<span class="token punctuation">,</span>
         <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">VariantClear</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pvarg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">VariantInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pvarg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rgsabound <span class="token operator">=</span> <span class="token punctuation">(</span>SAFEARRAYBOUND<span class="token punctuation">)</span><span class="token number">64</span>i64<span class="token punctuation">;</span>
    v16 <span class="token operator">=</span> <span class="token function">SafeArrayCreate</span><span class="token punctuation">(</span><span class="token number">0x11u</span><span class="token punctuation">,</span> <span class="token number">1u</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>rgsabound<span class="token punctuation">)</span><span class="token punctuation">;</span>
    v7 <span class="token operator">=</span> v16<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v16 <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      ppvData <span class="token operator">=</span> <span class="token number">0</span>i64<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">SafeArrayAccessData</span><span class="token punctuation">(</span>v16<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ppvData<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">sub_7FF9FF793120</span><span class="token punctuation">(</span>ppvData<span class="token punctuation">,</span> <span class="token number">64</span>i64<span class="token punctuation">,</span> a1<span class="token punctuation">)</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        v17 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a3 <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pvarg<span class="token punctuation">.</span>llVal <span class="token operator">=</span> <span class="token punctuation">(</span>LONGLONG<span class="token punctuation">)</span>v7<span class="token punctuation">;</span>
        pvarg<span class="token punctuation">.</span>vt <span class="token operator">=</span> <span class="token number">8209</span><span class="token punctuation">;</span>
        v6 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token punctuation">(</span>__fastcall <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>__int64<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">wchar_t</span> <span class="token operator">*</span><span class="token punctuation">,</span> _QWORD<span class="token punctuation">,</span> VARIANTARG <span class="token operator">*</span><span class="token punctuation">,</span> _DWORD<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>v17 <span class="token operator">+</span> <span class="token number">40</span>i64<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token comment">// &lt;fastprox.&amp;public: virtual long __cdecl CWbemInstance::Put(unsigned short const *, long, struct tagVARIANT *, long)&gt;]=&lt;fastprox.public: virtual long __cdecl CWbemInstance::Put(unsigned short const *, long, struct tagVARIANT *, long)&gt;</span>
               v17<span class="token punctuation">,</span>
               L<span class="token string">&quot;u8Input&quot;</span><span class="token punctuation">,</span>
               <span class="token number">0</span>i64<span class="token punctuation">,</span>
               <span class="token operator">&amp;</span>pvarg<span class="token punctuation">,</span>
               <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{</span>
    v6 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">VariantClear</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pvarg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v7 <span class="token punctuation">)</span>
    <span class="token function">SafeArrayDestroy</span><span class="token punctuation">(</span>v7<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> v6<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></p></details><p>和示例一样，<code>IWbemClassObject::Put</code>的第三个参数是<code>VARIANT</code>类型的数据。</p><p>根据伪代码可以得出参数套娃如下<code>VARIANT pvarg -&gt; SAFEARRAY *v16 -&gt; void *ppvData</code></p><p>根据这篇文档<a href="https://learn.microsoft.com/en-us/windows/win32/api/wtypes/ne-wtypes-varenum" target="_blank" rel="noopener noreferrer">https://learn.microsoft.com/en-us/windows/win32/api/wtypes/ne-wtypes-varenum<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 伪代码中<code>pvarg.vt = 8209;</code>即为<code>varCommand.vt = VT_ARRAY | VT_UI1;</code></p><p>根据<a href="https://learn.microsoft.com/en-us/windows/win32/api/oaidl/ns-oaidl-variant" target="_blank" rel="noopener noreferrer">https://learn.microsoft.com/en-us/windows/win32/api/oaidl/ns-oaidl-variant<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>得知<code>VARIANT</code>实质为C的<code>union</code>类型，此时该用<code>SAFEARRAY</code>类型赋值到<code>varCommand.parray</code></p><p>创建<code>SAFEARRAY</code>需要<code>SAFEARRAYBOUND</code>，这里得到<code>rgsabound.cElements = 64;</code></p><p>伪代码的<code>ppvData</code>即为实质数据，是通过<code>sub_7FF9FF793120</code>函数赋值的，把这个函数反编译：</p><details><summary>C++伪代码</summary><p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code>__int64 __fastcall <span class="token function">sub_7FF9FF793120</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>a1<span class="token punctuation">,</span> size_t a2<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>a3<span class="token punctuation">,</span> size_t a4<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>a4 <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0</span>i64<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>a1 <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
LABEL_3<span class="token operator">:</span>
    <span class="token operator">*</span><span class="token function">errno</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">22</span><span class="token punctuation">;</span>
    <span class="token function">invalid_parameter_noinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">22</span>i64<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> a3 <span class="token operator">&amp;&amp;</span> a2 <span class="token operator">&gt;=</span> a4 <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> a3<span class="token punctuation">,</span> a4<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span>i64<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>a3 <span class="token punctuation">)</span>
    <span class="token keyword">goto</span> LABEL_3<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> a2 <span class="token operator">&gt;=</span> a4 <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">22</span>i64<span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token function">errno</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">34</span><span class="token punctuation">;</span>
  <span class="token function">invalid_parameter_noinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">34</span>i64<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></p></details><p>原来只是对拷贝内存做了层封装，还原如下：</p><details><summary>C++</summary><p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">copyArr</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> dst<span class="token punctuation">,</span> size_t dstlength<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> src<span class="token punctuation">,</span> size_t srclength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>srclength<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>src<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">22</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dst<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">22</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>src <span class="token operator">&amp;&amp;</span> dstlength <span class="token operator">&gt;=</span> srclength<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> src<span class="token punctuation">,</span> srclength<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> dstlength<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">34</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></p></details><p>拷贝函数的第三个参数就是源数据指针，伪代码说是void类型，那我们在x64dbg里再看看具体是什么东西： <img src="/HuaweiBatteryControl/assets/6.3-13d7e05f.png" alt="6.3"> ok其实还是指向uint64的指针</p><p>参数传值还原后代码如下：</p><details><summary>C++</summary><p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token comment">// Create the values for the in parameters</span>
VARIANT varCommand<span class="token punctuation">;</span>
varCommand<span class="token punctuation">.</span>vt <span class="token operator">=</span> VT_ARRAY <span class="token operator">|</span> VT_UI1<span class="token punctuation">;</span>
SAFEARRAYBOUND rgsabound<span class="token punctuation">;</span>
rgsabound<span class="token punctuation">.</span>lLbound <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
rgsabound<span class="token punctuation">.</span>cElements <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>
SAFEARRAY<span class="token operator">*</span> sa <span class="token operator">=</span> <span class="token function">SafeArrayCreate</span><span class="token punctuation">(</span>VT_UI1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>rgsabound<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span><span class="token operator">*</span> ppvData <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span><span class="token function">SafeArrayAccessData</span><span class="token punctuation">(</span>sa<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ppvData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">copyArr</span><span class="token punctuation">(</span>ppvData<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    varCommand<span class="token punctuation">.</span>parray <span class="token operator">=</span> sa<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Store the value for the in parameters</span>
hres <span class="token operator">=</span> pClassInstance<span class="token operator">-&gt;</span><span class="token function">Put</span><span class="token punctuation">(</span>L<span class="token string">&quot;u8Input&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token operator">&amp;</span>varCommand<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></p></details><p><code>IWbemServices::ExecMethod</code>的第一个参数是<code>const BSTR strObjectPath</code>，x64dbg调试得出固定值<code>SysAllocString(L&quot;OemWMIMethod.InstanceName=&#39;ACPI\\PNP0C14\\HWMI_0&#39;&quot;);</code></p><h2 id="最终成果" tabindex="-1"><a class="header-anchor" href="#最终成果" aria-hidden="true">#</a> 最终成果</h2><details><summary>C++</summary><p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_WIN32_DCOM</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;comdef.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Wbemidl.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">comment</span><span class="token punctuation">(</span>lib<span class="token punctuation">,</span> </span><span class="token string">&quot;wbemuuid.lib&quot;</span><span class="token expression"><span class="token punctuation">)</span></span></span>

<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">copyArr</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> dst<span class="token punctuation">,</span> size_t dstlength<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> src<span class="token punctuation">,</span> size_t srclength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>srclength<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>src<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">22</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dst<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">22</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>src <span class="token operator">&amp;&amp;</span> dstlength <span class="token operator">&gt;=</span> srclength<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> src<span class="token punctuation">,</span> srclength<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> dstlength<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">34</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;\nCommand-line arguments:\n&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> count <span class="token operator">&lt;</span> argc<span class="token punctuation">;</span> count<span class="token operator">++</span><span class="token punctuation">)</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;  argv[&quot;</span> <span class="token operator">&lt;&lt;</span> count <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;]   &quot;</span>
        <span class="token operator">&lt;&lt;</span> argv<span class="token punctuation">[</span>count<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> data <span class="token operator">=</span> <span class="token number">0x46281003</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data <span class="token operator">=</span> <span class="token function">strtoul</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data <span class="token operator">=</span> <span class="token function">strtoul</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0x1000000</span> <span class="token operator">|</span> <span class="token function">strtoul</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0x10000</span> <span class="token operator">|</span> <span class="token number">0x1003</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;data:%llu(0x%llx)\n&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    HRESULT hres<span class="token punctuation">;</span>

    <span class="token comment">// Step 1: --------------------------------------------------</span>
    <span class="token comment">// Initialize COM. ------------------------------------------</span>

    hres <span class="token operator">=</span> <span class="token function">CoInitializeEx</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> COINIT_MULTITHREADED<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hres<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Failed to initialize COM library. Error code = 0x&quot;</span>
            <span class="token operator">&lt;&lt;</span> hex <span class="token operator">&lt;&lt;</span> hres <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>                  <span class="token comment">// Program has failed.</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Step 2: --------------------------------------------------</span>
    <span class="token comment">// Set general COM security levels --------------------------</span>

    hres <span class="token operator">=</span> <span class="token function">CoInitializeSecurity</span><span class="token punctuation">(</span>
        <span class="token constant">NULL</span><span class="token punctuation">,</span>
        <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>                          <span class="token comment">// COM negotiates service</span>
        <span class="token constant">NULL</span><span class="token punctuation">,</span>                        <span class="token comment">// Authentication services</span>
        <span class="token constant">NULL</span><span class="token punctuation">,</span>                        <span class="token comment">// Reserved</span>
        RPC_C_AUTHN_LEVEL_DEFAULT<span class="token punctuation">,</span>   <span class="token comment">// Default authentication </span>
        RPC_C_IMP_LEVEL_IMPERSONATE<span class="token punctuation">,</span> <span class="token comment">// Default Impersonation</span>
        <span class="token constant">NULL</span><span class="token punctuation">,</span>                        <span class="token comment">// Authentication info</span>
        EOAC_NONE<span class="token punctuation">,</span>                   <span class="token comment">// Additional capabilities </span>
        <span class="token constant">NULL</span>                         <span class="token comment">// Reserved</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hres<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Failed to initialize security. Error code = 0x&quot;</span>
            <span class="token operator">&lt;&lt;</span> hex <span class="token operator">&lt;&lt;</span> hres <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token function">CoUninitialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>                      <span class="token comment">// Program has failed.</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Step 3: ---------------------------------------------------</span>
    <span class="token comment">// Obtain the initial locator to WMI -------------------------</span>

    IWbemLocator<span class="token operator">*</span> pLoc <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    hres <span class="token operator">=</span> <span class="token function">CoCreateInstance</span><span class="token punctuation">(</span>
        CLSID_WbemLocator<span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span>
        CLSCTX_INPROC_SERVER<span class="token punctuation">,</span>
        IID_IWbemLocator<span class="token punctuation">,</span> <span class="token punctuation">(</span>LPVOID<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>pLoc<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hres<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Failed to create IWbemLocator object. &quot;</span>
            <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Err code = 0x&quot;</span>
            <span class="token operator">&lt;&lt;</span> hex <span class="token operator">&lt;&lt;</span> hres <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token function">CoUninitialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>                 <span class="token comment">// Program has failed.</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Step 4: ---------------------------------------------------</span>
    <span class="token comment">// Connect to WMI through the IWbemLocator::ConnectServer method</span>

    IWbemServices<span class="token operator">*</span> pSvc <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment">// Connect to the local root\cimv2 namespace</span>
    <span class="token comment">// and obtain pointer pSvc to make IWbemServices calls.</span>
    hres <span class="token operator">=</span> pLoc<span class="token operator">-&gt;</span><span class="token function">ConnectServer</span><span class="token punctuation">(</span>
        <span class="token function">_bstr_t</span><span class="token punctuation">(</span>L<span class="token string">&quot;ROOT\\WMI&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token constant">NULL</span><span class="token punctuation">,</span>
        <span class="token constant">NULL</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token constant">NULL</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>pSvc
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hres<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Could not connect. Error code = 0x&quot;</span>
            <span class="token operator">&lt;&lt;</span> hex <span class="token operator">&lt;&lt;</span> hres <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        pLoc<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CoUninitialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>                <span class="token comment">// Program has failed.</span>
    <span class="token punctuation">}</span>

    cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Connected to ROOT\\WMI WMI namespace&quot;</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>


    <span class="token comment">// Step 5: --------------------------------------------------</span>
    <span class="token comment">// Set security levels for the proxy ------------------------</span>

    hres <span class="token operator">=</span> <span class="token function">CoSetProxyBlanket</span><span class="token punctuation">(</span>
        pSvc<span class="token punctuation">,</span>                        <span class="token comment">// Indicates the proxy to set</span>
        RPC_C_AUTHN_WINNT<span class="token punctuation">,</span>           <span class="token comment">// RPC_C_AUTHN_xxx </span>
        RPC_C_AUTHZ_NONE<span class="token punctuation">,</span>            <span class="token comment">// RPC_C_AUTHZ_xxx </span>
        <span class="token constant">NULL</span><span class="token punctuation">,</span>                        <span class="token comment">// Server principal name </span>
        RPC_C_AUTHN_LEVEL_CALL<span class="token punctuation">,</span>      <span class="token comment">// RPC_C_AUTHN_LEVEL_xxx </span>
        RPC_C_IMP_LEVEL_IMPERSONATE<span class="token punctuation">,</span> <span class="token comment">// RPC_C_IMP_LEVEL_xxx</span>
        <span class="token constant">NULL</span><span class="token punctuation">,</span>                        <span class="token comment">// client identity</span>
        EOAC_NONE                    <span class="token comment">// proxy capabilities </span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hres<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Could not set proxy blanket. Error code = 0x&quot;</span>
            <span class="token operator">&lt;&lt;</span> hex <span class="token operator">&lt;&lt;</span> hres <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        pSvc<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pLoc<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CoUninitialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>               <span class="token comment">// Program has failed.</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Step 6: --------------------------------------------------</span>
    <span class="token comment">// Use the IWbemServices pointer to make requests of WMI ----</span>

    <span class="token comment">// set up to call the Win32_Process::Create method</span>
    BSTR MethodName <span class="token operator">=</span> <span class="token function">SysAllocString</span><span class="token punctuation">(</span>L<span class="token string">&quot;OemWMIfun&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    BSTR ClassName <span class="token operator">=</span> <span class="token function">SysAllocString</span><span class="token punctuation">(</span>L<span class="token string">&quot;OemWMIMethod&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    BSTR InstanceObjectPath <span class="token operator">=</span> <span class="token function">SysAllocString</span><span class="token punctuation">(</span>L<span class="token string">&quot;OemWMIMethod.InstanceName=&#39;ACPI\\PNP0C14\\HWMI_0&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    IWbemClassObject<span class="token operator">*</span> pClass <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    hres <span class="token operator">=</span> pSvc<span class="token operator">-&gt;</span><span class="token function">GetObject</span><span class="token punctuation">(</span>ClassName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pClass<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    IWbemClassObject<span class="token operator">*</span> pInParamsDefinition <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    hres <span class="token operator">=</span> pClass<span class="token operator">-&gt;</span><span class="token function">GetMethod</span><span class="token punctuation">(</span>MethodName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>pInParamsDefinition<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    IWbemClassObject<span class="token operator">*</span> pClassInstance <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    hres <span class="token operator">=</span> pInParamsDefinition<span class="token operator">-&gt;</span><span class="token function">SpawnInstance</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pClassInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the values for the in parameters</span>
    VARIANT varCommand<span class="token punctuation">;</span>
    varCommand<span class="token punctuation">.</span>vt <span class="token operator">=</span> VT_ARRAY <span class="token operator">|</span> VT_UI1<span class="token punctuation">;</span>
    SAFEARRAYBOUND rgsabound<span class="token punctuation">;</span>
    rgsabound<span class="token punctuation">.</span>lLbound <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    rgsabound<span class="token punctuation">.</span>cElements <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>
    SAFEARRAY<span class="token operator">*</span> sa <span class="token operator">=</span> <span class="token function">SafeArrayCreate</span><span class="token punctuation">(</span>VT_UI1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>rgsabound<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span><span class="token operator">*</span> ppvData <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span><span class="token function">SafeArrayAccessData</span><span class="token punctuation">(</span>sa<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ppvData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">copyArr</span><span class="token punctuation">(</span>ppvData<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        varCommand<span class="token punctuation">.</span>parray <span class="token operator">=</span> sa<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Store the value for the in parameters</span>
    hres <span class="token operator">=</span> pClassInstance<span class="token operator">-&gt;</span><span class="token function">Put</span><span class="token punctuation">(</span>L<span class="token string">&quot;u8Input&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>varCommand<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//wprintf(L&quot;The command is: %d %d\n&quot;, ppvData, ppvData[0]);</span>

    <span class="token comment">// Execute Method</span>
    IWbemClassObject<span class="token operator">*</span> pOutParams <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    hres <span class="token operator">=</span> pSvc<span class="token operator">-&gt;</span><span class="token function">ExecMethod</span><span class="token punctuation">(</span>InstanceObjectPath<span class="token punctuation">,</span> MethodName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token constant">NULL</span><span class="token punctuation">,</span> pClassInstance<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pOutParams<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hres<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Could not execute method. Error code = 0x&quot;</span>
            <span class="token operator">&lt;&lt;</span> hex <span class="token operator">&lt;&lt;</span> hres <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token function">VariantClear</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>varCommand<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SysFreeString</span><span class="token punctuation">(</span>ClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SysFreeString</span><span class="token punctuation">(</span>MethodName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SysFreeString</span><span class="token punctuation">(</span>InstanceObjectPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SafeArrayDestroy</span><span class="token punctuation">(</span>sa<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pClass<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pClassInstance<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pInParamsDefinition<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pOutParams<span class="token punctuation">)</span>pOutParams<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pSvc<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pLoc<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CoUninitialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>               <span class="token comment">// Program has failed.</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// To see what the method returned,</span>
    <span class="token comment">// use the following code.  The return value will</span>
    <span class="token comment">// be in &amp;varReturnValue</span>
    VARIANT varReturnValue<span class="token punctuation">;</span>
    varReturnValue<span class="token punctuation">.</span>vt <span class="token operator">=</span> VT_ARRAY <span class="token operator">|</span> VT_UI1<span class="token punctuation">;</span>
    hres <span class="token operator">=</span> pOutParams<span class="token operator">-&gt;</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token function">_bstr_t</span><span class="token punctuation">(</span>L<span class="token string">&quot;u8Output&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>varReturnValue<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">(</span><span class="token operator">*</span>returnData<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>varReturnValue<span class="token punctuation">.</span>parray<span class="token operator">-&gt;</span>pvData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;u8Output:%llu\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span>returnData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// Clean up</span>
    <span class="token comment">//--------------------------</span>
    <span class="token function">VariantClear</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>varCommand<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">VariantClear</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>varReturnValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SysFreeString</span><span class="token punctuation">(</span>ClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SysFreeString</span><span class="token punctuation">(</span>MethodName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SysFreeString</span><span class="token punctuation">(</span>InstanceObjectPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SafeArrayDestroy</span><span class="token punctuation">(</span>sa<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pClass<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pClassInstance<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pInParamsDefinition<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pOutParams<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pLoc<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pSvc<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CoUninitialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></p></details><div class="language-powershell line-numbers-mode" data-ext="powershell"><pre class="language-powershell"><code><span class="token function">PS</span> D:\&gt; HuaweiBatteryControl-x64<span class="token punctuation">.</span>exe 70 40

Command-line arguments:
  argv<span class="token punctuation">[</span>0<span class="token punctuation">]</span>   d:\<span class="token function">cli</span><span class="token operator">-</span>tools\HuaweiBatteryControl-x64<span class="token punctuation">.</span>exe
  argv<span class="token punctuation">[</span>1<span class="token punctuation">]</span>   70
  argv<span class="token punctuation">[</span>2<span class="token punctuation">]</span>   40
<span class="token keyword">data</span>:1177030659<span class="token punctuation">(</span>0x46281003<span class="token punctuation">)</span>
Connected to ROOT\WMI WMI namespace
u8Output:0
<span class="token function">PS</span> D:\&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在任务计划程序里新建开机自启任务，这就可以替代掉华为的电脑管家服务了</p><p>开源地址：<a href="https://github.com/AceDroidX/HuaweiBatteryControl" target="_blank" rel="noopener noreferrer">https://github.com/AceDroidX/HuaweiBatteryControl<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>文章使用<a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer">知识共享署名-相同方式共享 4.0 国际许可协议(CC BY-SA 4.0)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>进行许可</p></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 15519693+AceDroidX@users.noreply.github.com">AceDroidX</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/HuaweiBatteryControl/assets/app-659d6a32.js" defer></script>
  </body>
</html>
